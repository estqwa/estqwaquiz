<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ | Trivia API Admin</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="app.js"></script>
    <script type="module">
        import authService from './authService.js';
        import { formatDate, DateFormat } from './dateUtils.js';

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º formatDate –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–∞—Ö
        window.formatDate = formatDate;
        window.DateFormat = DateFormat;

        document.addEventListener('DOMContentLoaded', async () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            await authService.init();
            if (!authService.isAuthenticated()) {
                window.location.href = 'index.html?showLogin=true';
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
            loadSessions();

            // –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫ –∫–Ω–æ–ø–∫–∞–º
            document.getElementById('logout-all').addEventListener('click', logoutAllDevices);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            document.getElementById('back-to-admin').addEventListener('click', function() {
                window.location.href = 'index.html';
            });
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
        async function loadSessions() {
            try {
                const sessions = await authService.getActiveSessions();
                renderSessions(sessions);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Å—Å–∏–π:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π
        function renderSessions(data) {
            const sessionsContainer = document.getElementById('sessions-list');
            sessionsContainer.innerHTML = '';

            if (!data || !data.sessions || data.sessions.length === 0) {
                sessionsContainer.innerHTML = '<p class="empty-message">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π</p>';
                return;
            }

            const currentTime = new Date();
            const sessions = data.sessions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            sessions.forEach(session => {
                const createdDate = new Date(session.created_at);
                const expiresDate = new Date(session.expires_at);
                const isExpired = expiresDate < currentTime;
                const isCurrent = session.id === authService.currentSessionId;

                const sessionElement = document.createElement('div');
                sessionElement.className = `session-item ${isExpired ? 'expired' : ''} ${isCurrent ? 'current' : ''}`;
                
                sessionElement.innerHTML = `
                    <div class="session-info">
                        <div class="session-header">
                            <h3>${formatDeviceName(session.user_agent)}</h3>
                            ${isCurrent ? '<span class="current-badge">–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è</span>' : ''}
                        </div>
                        <p><strong>IP:</strong> ${session.ip_address}</p>
                        <p><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</strong> ${formatDate(session.last_used_at, DateFormat.MEDIUM)}</p>
                        <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${formatDate(createdDate, DateFormat.SHORT)}</p>
                        <p><strong>–ò—Å—Ç–µ–∫–∞–µ—Ç:</strong> ${formatDate(expiresDate, DateFormat.SHORT)}</p>
                    </div>
                    <div class="session-actions">
                        ${!isCurrent ? `<button class="btn btn-danger session-logout" data-id="${session.id}">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>` : ''}
                    </div>
                `;

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
                const logoutButton = sessionElement.querySelector('.session-logout');
                if (logoutButton) {
                    logoutButton.addEventListener('click', () => terminateSession(session.id));
                }

                sessionsContainer.appendChild(sessionElement);
            });
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏
        async function terminateSession(sessionId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —ç—Ç—É —Å–µ—Å—Å–∏—é?')) {
                return;
            }

            try {
                await authService._authorizedRequest(`/api/auth/revoke-session`, {
                    method: 'POST',
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                showSuccess('–°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                loadSessions(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é');
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π
        async function logoutAllDevices() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏? –í–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ.')) {
                return;
            }

            try {
                await authService.logoutAllDevices();
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ authService
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏');
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ User-Agent
        function formatDeviceName(userAgent) {
            if (!userAgent) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';

            // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –±—Ä–∞—É–∑–µ—Ä–∞
            const isWindows = userAgent.includes('Windows');
            const isMac = userAgent.includes('Macintosh');
            const isLinux = userAgent.includes('Linux');
            const isAndroid = userAgent.includes('Android');
            const isIOS = userAgent.includes('iPhone') || userAgent.includes('iPad');

            let device = '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
            if (isWindows) device = 'Windows';
            else if (isMac) device = 'Mac';
            else if (isLinux && !isAndroid) device = 'Linux';
            else if (isAndroid) device = 'Android';
            else if (isIOS) device = 'iOS';

            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
            let browser = '';
            if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) browser = 'Chrome';
            else if (userAgent.includes('Firefox')) browser = 'Firefox';
            else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) browser = 'Safari';
            else if (userAgent.includes('Edg')) browser = 'Edge';
            else if (userAgent.includes('MSIE') || userAgent.includes('Trident')) browser = 'Internet Explorer';
            else browser = '–ë—Ä–∞—É–∑–µ—Ä';

            return `${device} / ${browser}`;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'toast toast-error';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ
        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.className = 'toast toast-success';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
    <style>
        .sessions-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .sessions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .sessions-title {
            font-size: 24px;
            margin: 0;
        }
        
        .back-btn {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        
        .back-btn::before {
            content: "‚Üê";
            margin-right: 6px;
            font-size: 16px;
        }
        
        .back-btn:hover {
            background-color: #e0e0e0;
        }
        
        .session-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .session-item.current {
            border-color: #2196F3;
            background-color: #E3F2FD;
        }
        
        .session-item.expired {
            opacity: 0.7;
            background-color: #f5f5f5;
        }
        
        .session-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .session-header h3 {
            margin: 0;
            margin-right: 10px;
        }
        
        .current-badge {
            background-color: #2196F3;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .session-info {
            flex: 1;
        }
        
        .session-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .session-actions {
            display: flex;
            align-items: center;
        }
        
        .empty-message {
            text-align: center;
            font-style: italic;
            color: #666;
            padding: 20px;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .security-nav-item {
            border-left: 3px solid #ff5722;
            position: relative;
        }
        
        .security-nav-item::before {
            content: "üîê";
            margin-right: 6px;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .security-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">Trivia API Admin</div>
            <ul>
                <li><a href="index.html">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a></li>
                <li><a href="sessions.html" class="active security-nav-item">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏</a></li>
                <li><a href="ws-cluster-test.html">–¢–µ—Å—Ç –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏</a></li>
                <li><a href="#" id="logout-btn">–í—ã—Ö–æ–¥</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="sessions-container">
            <div class="sessions-header">
                <div class="header-left">
                    <button id="back-to-admin" class="back-btn">–ù–∞–∑–∞–¥ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</button>
                    <h1 class="sessions-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å–µ—Å—Å–∏—è–º–∏</h1>
                </div>
                <button id="logout-all" class="btn btn-danger">–í—ã–π—Ç–∏ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</button>
            </div>
            
            <div class="info-box security-info">
                <p><strong>üîê –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:</strong> –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å–µ—Å—Å–∏—è–º–∏. –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –ø–æ–º–æ–≥–∞–µ—Ç –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∏ –∑–∞—â–∏—Ç–∏—Ç—å –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç.</p>
                <p>–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∏–ª–∏ –≤—ã–π—Ç–∏ —Å—Ä–∞–∑—É —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ —Å–ª—É—á–∞–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.</p>
            </div>
            
            <div id="sessions-list" class="sessions-list">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π...</div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2023 Trivia API Admin Panel</p>
    </footer>
</body>
</html> 